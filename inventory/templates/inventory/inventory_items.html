{% extends 'inventory/dashboard.html' %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/inventory_items.css' %}">

<div class="container">
    <main class="main-content">
        <div class="content-header">
            <h1>Inventory</h1>
            <div class="search-add">
                <div class="search-container">
                    <input type="text" id="searchInput" placeholder="Search" oninput="searchItems()">
                    <select id="categoryFilter" onchange="filterByCategory()">
                        <option value="">All Categories</option>
                        {% for category in categories %}
                            <option value="{{ category }}" {% if category == selected_category %}selected{% endif %}>
                                {{ category }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                <button class="add-product" onclick="openAddProductModal()">Add New Product</button>
            </div>
        </div>
        
        <table class="inventory-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Item Name</th>
                    <th>Category</th>
                    <th>Quantity</th>
                    <th>Price</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="inventoryTableBody">
                {% for item in inventory_items %}
                <tr>
                    <td>{{ item.id }}</td>
                    <td>{{ item.name }}</td>
                    <td>{{ item.category }}</td>
                    <td>{{ item.quantity }}</td>
                    <td>â‚±{{ item.price|floatformat:2 }}</td>
                    <td>
                        <button class="edit" onclick="editItem('{{ item.id }}')"><i class="fas fa-edit"></i></button>
                        <button class="delete" onclick="deleteItem('{{ item.id }}')"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>   
                {% empty %}
                <tr>
                    <td colspan="7">No inventory items found.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <button class="go-back" onclick="history.back()">Go Back</button>
    </main>

    <div id="addProductModal" class="modal">
        <div class="modal-content">
            <span onclick="closeAddProductModal()" class="close">&times;</span>
            <h2>Add New Product</h2>
            <form id="addProductForm" onsubmit="submitAddProduct(event)">
                <label for="name">Name:</label>
                <input type="text" id="name" name="name" required class="highlighted"><br><br>
                <label for="category">Category:</label>
                <input type="text" id="category" name="category" required class="highlighted"><br><br>
                <label for="quantity">Quantity:</label>
                <input type="number" id="quantity" name="quantity" required class="highlighted"><br><br>
                <label for="price">Price:</label>
                <input type="number" id="price" name="price" step="0.01" required class="highlighted"><br><br>
                <button type="submit" class="add-product">Add Product</button>
            </form>
        </div>
</div>

<div id="editProductModal" class="modal">
    <div class="modal-content">
        <span onclick="closeEditProductModal()" class="close">&times;</span>
        <h2>Edit Product</h2>
        <form id="editProductForm" onsubmit="submitEditProduct(event)">
            <input type="hidden" id="editItemId" name="editItemId">
            <label for="editName">Name:</label>
            <input type="text" id="editName" name="editName" required><br><br>
            <label for="editCategory">Category:</label>
            <input type="text" id="editCategory" name="editCategory" required><br><br>
            <label for="editQuantity">Quantity:</label>
            <input type="number" id="editQuantity" name="editQuantity" required><br><br>
            <label for="editPrice">Price:</label>
            <input type="number" id="editPrice" name="editPrice" step="0.01" required><br><br>
            <button type="submit">Update Product</button>
        </form>
    </div>
</div>

<style>
    
.search-add {
    display: flex;
    justify-content: flex-end;
    align-items: center;
    margin-bottom: 20px;
}

.search-container {
    position: relative;
    display: inline-block;
    margin-right: 15px;
}

#searchInput {
    padding-right: 60px;
    width: 200px;
    height: 36px;
    border: 1px solid #ccc;
    border-radius: 18px;
    padding-left: 15px;
    font-size: 14px;
}

.search-icon,
.filter-icon {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    cursor: pointer;
}

.search-icon {
    right: 30px;
}

.filter-icon {
    right: 10px;
}

.add-product {
    background-color: #4CAF50; 
    color: white;
    padding: 10px 20px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 16px;
}

.add-product:hover {
    background-color: #45a049; 
}

.modal {
  display: none;
  position: fixed;
  z-index: 1;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  overflow: auto;
  background-color: rgba(0,0,0,0.4);
}

.modal-content {
   background-color: #fefefe;
   margin: 15% auto;
   padding: 20px;
   border: 1px solid #888;
   width: 80%;
   max-width: 500px;
}

.close {
  color: #aaa;
  float: right;
  font-size: 28px;
  font-weight: bold;
  cursor: pointer;
}

.close:hover,
.close:focus {
  color: black;
  text-decoration: none;
  cursor: pointer;
}

.highlighted {
  border: 2px solid #4CAF50; 
  padding: 10px;
  border-radius: 5px;
  width: calc(100% - 20px); 
}

.add-product {
  background-color: #4CAF50; 
  padding: 10px 20px; 
  border: none;
  border-radius: 5px; 
  cursor: pointer; 
  width: 300px; 
  font-size: 16px;
}

.add-product:hover {
  background-color: #45a049; 
}
</style>
<script>
 
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }

    const searchItems = debounce(() => {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        const url = new URL(window.location);
        url.searchParams.set('search', searchTerm);

        fetch(url)
            .then(response => response.text())
            .then(html => {
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const newTableBody = doc.getElementById('inventoryTableBody');
                document.getElementById('inventoryTableBody').innerHTML = newTableBody.innerHTML;
            })
            .catch(error => console.error('Error:', error));
    }, 300);

    function filterByCategory() {
        const category = document.getElementById('categoryFilter').value;
        const search = document.getElementById('searchInput').value.toLowerCase();
        const url = new URL(window.location);

        url.searchParams.set('category', category);
        if (search) {
            url.searchParams.set('search', search);
        }

        fetch(url)
            .then(response => response.text())
            .then(html => {
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const newTableBody = doc.getElementById('inventoryTableBody');
                document.getElementById('inventoryTableBody').innerHTML = newTableBody.innerHTML;
            })
            .catch(error => console.error('Error:', error));
    }

    function triggerSearch() {
        searchItems();
    }

    document.getElementById('searchInput').addEventListener('input', searchItems);
    document.querySelector('.search-icon').addEventListener('click', triggerSearch);

    function openAddProductModal() {
        document.getElementById('addProductModal').style.display = 'block';
    }

    function closeAddProductModal() {
        document.getElementById('addProductModal').style.display = 'none';
        document.getElementById('addProductForm').reset();
    }

   

    // Capture the addProductUrl and confirm its value
    const addProductUrl = "{% url 'add_product' %}";
    console.log("Add Product URL:", addProductUrl);  // Log to verify URL

    function submitAddProduct(event) {
        event.preventDefault();
        
        // Collect form data
        const formData = {
            name: document.getElementById('name').value,
            category: document.getElementById('category').value,
            quantity: document.getElementById('quantity').value,
            price: document.getElementById('price').value,
        };

        console.log("Form data:", formData);  // Debugging form data

        // Fetch request to add the product
        fetch(addProductUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken'),  // Django CSRF Token
            },
            body: JSON.stringify(formData),
        })
        .then(response => response.json())
        .then(data => {
            console.log("Server response:", data);  // Debugging server response
            
            if (data.error) {
                alert('Failed to add product: ' + data.error);  // Error handling
            } else {
                closeAddProductModal();
                addProductToTable(data);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred. Check console for details.');  // Alert if there's a fetch error
        });
    }

    // Ensure the form is listening for submit events
    document.getElementById('addProductForm').addEventListener('submit', submitAddProduct);

    function addProductToTable(product) {
        const tableBody = document.getElementById('inventoryTableBody');
        
        // Remove "No inventory items found" row if it exists
        const noItemsRow = tableBody.querySelector('tr td[colspan="6"]');
        if (noItemsRow) {
            noItemsRow.parentElement.remove();
        }

        // Create a new row for the product
        const newRow = tableBody.insertRow();
        newRow.setAttribute('data-id', product.id);
        newRow.innerHTML = `
            <td>${product.id}</td>
            <td>${product.name}</td>
            <td>${product.category}</td>
            <td>${product.quantity}</td>
            <td>â‚±${parseFloat(product.price).toFixed(2)}</td>
            <td>
                <button class="edit" onclick="editItem('${product.id}')"><i class="fas fa-edit"></i></button>
                <button class="delete" onclick="deleteItem('${product.id}')"><i class="fas fa-trash"></i></button>
            </td>
        `;
    }
    function editItem(itemId) {
        // Fetch the item details
        fetch(`/get-item/${itemId}/`)
            .then(response => response.json())
            .then(data => {
                // Populate the modal with the item details
                document.getElementById('editItemId').value = data.id;
                document.getElementById('editName').value = data.name;
                document.getElementById('editCategory').value = data.category;
                document.getElementById('editQuantity').value = data.quantity;
                document.getElementById('editPrice').value = data.price;
               

                // Open the modal
                document.getElementById('editProductModal').style.display = 'block';
            })
            .catch(error => console.error('Error:', error));
    }

    function closeEditProductModal() {
        document.getElementById('editProductModal').style.display = 'none';
    }

    function submitEditProduct(event) {
        event.preventDefault();
        const itemId = document.getElementById('editItemId').value;
        const formData = {
            name: document.getElementById('editName').value,
            category: document.getElementById('editCategory').value,
            quantity: document.getElementById('editQuantity').value,
            price: document.getElementById('editPrice').value,
            
        };

        fetch(`/edit-item/${itemId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken'),
            },
            body: JSON.stringify(formData),
        })
        .then(response => response.json())
        .then(data => {
            console.log('Edit product:', data);
            closeEditProductModal();
            updateProductInTable(data);
        })
        .catch(error => console.error('Error:', error));
    }

    function updateProductInTable(product) {
        const tableBody = document.getElementById('inventoryTableBody');
        const row = tableBody.querySelector(`tr[data-id="${product.id}"]`);
        if (row) {
            row.innerHTML = `
                <td>${product.id}</td>
                <td>${product.name}</td>
                <td>${product.category}</td>
                <td>${product.quantity}</td>
                <td>â‚±${parseFloat(product.price).toFixed(2)}</td>
                
                <td>
                    <button class="edit" onclick="editItem('${product.id}')"><i class="fas fa-edit"></i></button>
                    <button class="delete" onclick="deleteItem('${product.id}')"><i class="fas fa-trash"></i></button>
                </td>
            `;
        }
    }

    function deleteItem(itemId) {
        if (confirm("Are you sure you want to delete this item?")) {
            fetch(`/delete-item/${itemId}/`, {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                },
            })
            .then(response => {
                if (response.ok) {
                    const tableBody = document.getElementById('inventoryTableBody');
                    const row = tableBody.querySelector(`tr[data-id="${itemId}"]`);
                    if (row) {
                        row.remove(); // Remove the row from the table
                    }

                    // If no items left, show the "No inventory items found." message
                    if (tableBody.rows.length === 0) {
                        const emptyRow = tableBody.insertRow();
                        emptyRow.innerHTML = '<td colspan="7">No inventory items found.</td>';
                    }
                } else {
                    alert('Failed to delete the item. Please try again.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while deleting the item.');
            });
        }
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }


</script>

{% endblock %}
